# Улучшения и идеи для бота

## Что уже сделано в этом обновлении

- **Кнопка «Назад в меню»** после карточки трека: для сообщений с фото используется удаление + новое сообщение с меню (в Telegram нельзя заменить фото на текст через `edit_message_text`).
- **Загрузка трека**: уведомление «Загрузка началась», статус «Отправляю файл» / «Готово!», блокировка повторного нажатия на время загрузки.
- **Визуал**: разделители в тексте (━━━━), единый стиль заголовков с *Markdown*, короткие подписи (Уровень · EXP · до след. уровня).

---

## Рекомендации по развитию

### 1. Надёжность и производительность

- **Очередь загрузок**: при большом числе пользователей вынести скачивание в фоновую задачу (Celery, asyncio.Queue) и уведомлять по готовности.
- **Лимиты**: ограничить число запросов к API Яндекс.Музыки (rate limit) и число одновременных загрузок на пользователя.
- **Повторы при ошибках**: retry с экспоненциальной задержкой для `download_track_bytes` и поиска.

### 2. UX

- **Пагинация**: в чарте и «Мои оценки» — кнопки «◀ Назад» / «Вперёд ▶» с шагом по 10.
- **Отмена**: явная кнопка «Отмена» в состоянии «пишу рецензию».
- **Подсказки**: при первом заходе — короткий туториал (например, «Попробуй Трек дня или Найти трек»).

### 3. Визуал и подача (как в «нормальных» ботах)

- **Единый стиль сообщений**: короткие блоки, разделители, эмодзи только где нужны (меню, карточка, ошибки).
- **Прогресс-бар уровня**: текст вида `[████░░░░░░] 40 EXP до 2 уровня` в приветствии.
- **Карточка трека**: при желании — одна строка с рейтингом из БД («Средний балл: 42/50, 12 оценок»).
- **Кнопки**: не более 2–3 в ряд; «Главное меню» всегда внизу отдельной кнопкой (уже так).

### 4. Функционал

- **История поиска**: хранить последние 5 запросов и кнопку «Повторить поиск».
- **Поделиться треком**: кнопка «Поделиться» с `switch_inline_query` для отправки трека в другой чат.
- **Напоминания**: «Трек дня уже обновился» (если бот умеет отправлять сообщения по расписанию).
- **Топ по жанру**: фильтр в общей статистике по жанру (из данных треков).

### 5. Технически

- **Логирование**: структурированные логи (JSON) с `user_id`, `handler`, `duration` для разбора сбоев.
- **Метрики**: счётчики команд, поисков, скачиваний, оценок (например, Prometheus или простой файл/БД).
- **Конфиг**: вынести все тексты и лимиты в `config.py` или YAML, чтобы менять без правок кода.
- **Миграции БД**: версионирование схемы (Alembic или скрипты миграций) при добавлении полей.

### 6. Безопасность

- **Санитизация**: экранирование Markdown в пользовательских строках (никнейм, рецензия), чтобы не ломать разметку и не внедрять код.
- **Токен**: хранить `YANDEX_MUSIC_TOKEN` только в переменных окружения или секретном хранилище, не в репозитории.

---

## Что ещё можно сделать «как в интернете»

- **Mini App**: веб-интерфейс для каталога и плейлистов (как у WaveTune) — удобно для больших списков и красивого отображения обложек.
- **Inline-режим**: ввод `@bot query` в любом чате — быстрый поиск и отправка трека в текущий чат.
- **Команды**: `/chart`, `/search Текст`, `/stats` для быстрого доступа без меню.
- **Локализация**: переключатель языка (RU/EN) и хранение выбора в БД/конфиге.
- **Реферальная система**: приглашение друзей даёт бонус EXP или отдельные достижения.

---

## Запуск тестов

```bash
pip install -r requirements.txt
python -m pytest tests/ -v
```

Тесты проверяют: БД (таблицы, пользователи, оценки, избранное, EXP), `utils` (hash_id, константы), клавиатуры (наличие нужных callback_data), формирование подписей и работу сервиса без реального API.
